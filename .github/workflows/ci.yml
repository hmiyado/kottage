name: CI

on: [pull_request]

jobs:
  check_changes:
    name: Check file changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.changes.outputs.backend }}
      frontend: ${{ steps.changes.outputs.frontend }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/**'
            frontend:
              - 'frontend/**'
              - '.github/workflows/**'

  backend_lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    needs: check_changes
    if: ${{ needs.check_changes.outputs.backend == 'true' }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Lint Code Base
        uses: github/super-linter/slim@v7
        env:
          FILTER_REGEX_EXCLUDE: gradlew
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_EDITORCONFIG: true
          VALIDATE_GITHUB_ACTIONS: true
          VALIDATE_GROOVY: true
          VALIDATE_JSON: true
          VALIDATE_KOTLIN: true
          VALIDATE_MARKDOWN: true
          VALIDATE_OPENAPI: true
          VALIDATE_SHELL_SHFMT: true
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  backend_test:
    name: Backend Test
    runs-on: ubuntu-latest
    needs: check_changes
    if: ${{ needs.check_changes.outputs.backend == 'true' }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: actions/setup-java@v4
        with:
          distribution: 'adopt'
          java-version: '11'
      - name: Prepare env
        working-directory: backend
        run: |
          mv .ci.env .env
          mv .ci.db-env .db-env
      - name: Run Server
        working-directory: backend
        run: sh scripts/run-on-docker.sh
      - name: Run Test
        working-directory: backend
        run: ./gradlew test

  frontend_test:
    name: Frontend Test
    runs-on: ubuntu-latest
    needs: check_changes
    if: ${{ needs.check_changes.outputs.frontend == 'true' }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '23'
          cache: 'yarn'
          cache-dependency-path: 'frontend/yarn.lock'
      - name: git setting
        run: |
          git config --local user.email "10195648+hmiyado@users.noreply.github.com"
          git config --local user.name "hmiyado"
      - name: Initialize frontend
        working-directory: frontend
        run: yarn initialize
      - name: Update patch package
        working-directory: frontend
        env:
          SOURCE_BRANCH: ${{ github.head_ref }}
        run: sh scripts/update-patch-package.sh
      - name: Verify OpenAPI client
        working-directory: frontend
        run: sh scripts/verify-openapi-client.sh
      - name: Run lint
        working-directory: frontend
        run: yarn lint
      - name: Run tests
        working-directory: frontend
        run: yarn test